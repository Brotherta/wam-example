<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Example 5 : Vu Meter</title>
    <link rel="icon" type="image/x-icon" href="../assets/images/wam-logo.png">
    <link rel="stylesheet" type="text/css" href="../lib/fomantic-ui/semantic.css">
    <link rel="stylesheet" href="../lib/prism/prism.css">
    <link rel="stylesheet" type="text/css" href="../lib/css/style.css">
    <script src="../lib/jquery/jquery-3.6.1.min.js"></script>
    <script src="../lib/fomantic-ui/semantic.js"></script>
</head>
<body>

<div class="ui visible left sidebar inverted vertical menu">
    <div class="item">
        <a class="ui logo icon image" href="/index.html">
            <img src="../assets/images/wam-logo.png" alt="logo wam" width="50px">
        </a>
        <a href="https://github.com/webaudiomodules">
            <b>Web Audio Modules</b>
        </a>
    </div>

    <a href="../example1-js/index.html" id="example1" class="item">Example 1</a>
    <div class="menu">
        <a class="item" href="../example1-js/index.html#demo">Demo</a>
        <a class="item" href="../example1-js/index.html#specifications">Specifications</a>
        <a class="item" href="../example1-js/index.html#prerequisites">Prerequisites</a>
        <a class="item" href="../example1-js/index.html#index">Index.html</a>
        <a class="item" href="../example1-js/index.html#operable">Operable audio buffer</a>
        <a class="item" href="../example1-js/index.html#main">Main script</a>
        <a class="item" href="../example1-js/index.html#init">Initialization</a>
        <a class="item" href="../example1-js/index.html#connection">Audio node connection</a>
        <a class="item" href="../example1-js/index.html#processor">Audio processor</a>
        <a class="item" href="../example1-js/index.html#conclusion">Conclusion</a>
    </div>
    <a href="../example2-js-cpp/index.html" id="example2" class="item">Example 2</a>
    <div class="menu">
        <a class="item" href="../example2-js-cpp/index.html#demo">Demo</a>
        <a class="item" href="../example2-js-cpp/index.html#specifications">Specifications</a>
        <a class="item" href="../example2-js-cpp/index.html#prerequisites">Prerequisites</a>
        <a class="item" href="../example2-js-cpp/index.html#makefile">Makefile compiling Emscripten</a>
        <a class="item" href="../example2-js-cpp/index.html#cpp">C++ File</a>
        <a class="item" href="../example2-js-cpp/index.html#audio-node">Custom Audio Node</a>
        <a class="item" href="../example2-js-cpp/index.html#instantiate">Instantiate Web Assembly</a>
        <a class="item" href="../example2-js-cpp/index.html#heaps">Initialize the heaps</a>
        <a class="item" href="../example2-js-cpp/index.html#conclusion">Conclusion</a>
    </div>
    <a href="../example3/index.html" id="example3" class="item">Example 3</a>
    <div class="menu">
        <a class="item" href="../example3/index.html#demo">Demo</a>
        <a class="item" href="../example3/index.html#specifications">Specifications</a>
        <a class="item" href="../example3/index.html#prerequisites">Prerequisites</a>
        <a class="item" href="../example3/index.html#WAM">Web Audio Modules</a>
        <a class="item" href="../example3/index.html#initialize">WAM SDK</a>
        <a class="item" href="../example3/index.html#creating">Instantiate plugins</a>
        <a class="item" href="../example3/index.html#processor">Custom WAM processor</a>
        <a class="item" href="../example3/index.html#conclusion">Conclusion</a>
    </div>
    <a href="../example4/index.html" id="example4" class="item">Example 4</a>
    <div class="menu">
        <a class="item" href="../example4/index.html#demo">Demo</a>
        <a class="item" href="../example4/index.html#specifications">Specifications</a>
        <a class="item" href="../example4/index.html#prerequisites">Prerequisites</a>
        <a class="item" href="../example4/index.html#simulate">Simulate plugin automation</a>
        <a class="item" href="../example4/index.html#connecting">Connecting WAM events</a>
        <a class="item" href="../example4/index.html#handling">Handling events in processor</a>
        <a class="item" href="../example4/index.html#conclusion">Conclusion</a>
    </div>
    <a id="example5" class="active item">Example 5</a>
    <div class="menu">
        <a class="item" href="#demo">Demo</a>
        <a class="item" href="#specifications">Specifications</a>
        <a class="item" href="#vu-meter">Vu meter class</a>
        <a class="item" href="#send">Sending data from the processor</a>
        <a class="item" href="#receive">Receive data from the host</a>
        <a class="item" href="#conclusion">Conclusion</a>
    </div>
    <a href="../example6/index.html" id="example6" class="item active">Example 6</a>
    <div class="menu">
        <a class="item" href="../example6/index.html#demo">Demo</a>
        <a class="item" href="../example6/index.html#specifications">Specifications</a>
        <a class="item" href="../example6/index.html#prerequisites">Prerequisites</a>
        <a class="item" href="../example6/index.html#connection">Connection to MIDI</a>
        <a class="item" href="../example6/index.html#conclusion">Conclusion</a>
    </div>
    <div class="item">
        <a class="ui logo icon image" href="https://github.com/Brotherta/wam-examples">
            <img src="../assets/images/github-logo-light.png" alt="logo wam" width="25px">
        </a>
        <a href="https://github.com/Brotherta/wam-examples">
            <b>Github repository</b>
        </a>
    </div>
</div>

<div class="example-container">
    <h2 id="demo" class="ui dividing header">
        Example : Simple Vu Meter
    </h2>

    <button id="btn-start-demo" class="ui button">Start Demo</button>

    <div id="demo-div" style="display: none">
        <div id="loading-wheel" class="loading">
            <img id="loading-gif" src="../assets/images/circle-loading.gif" alt="loading">
        </div>

        <div id="widget-loading" style="display: none">
            <h4 class="ui dividing header">Guitar Song : <a
                    href="https://www.chosic.com/download-audio/29514/">https://www.chosic.com/download-audio/29514/</a>
            </h4>
            <div class="wave">
                <canvas id="canvas1"></canvas>
            </div>
            <div class="demo-controls">
                <button id="btn-start" class="ui button">Start</button>
                <div class="ui toggle checkbox">
                    <input type="checkbox" name="loop" id="input-loop">
                    <label>Loop</label>
                </div>
            </div>
            <div class="vu-meter">
                <canvas id="canvas2"></canvas>
            </div>
        </div>
    </div>

    <section class="tutorial">
        <h3 class="ui dividing header" id="specifications">
            Specifications :
        </h3>
        <p>
            This example demonstrates how to communicate real-time data from the processor to the host. It requires using
            the postMessage method.
        </p>

        <h3 class="ui dividing header" id="vu-meter">
            Vu-meter class :
        </h3>
        <p>
            We will create a simple canvas with a gradient rule for the style. Nothing particular in this code.
        </p>
<pre class="code-snippets line-numbers">
<code class="language-js">// vu-meter.js
class VuMeter {

    constructor(canvas, height, width) {
        this.canvas = canvas;
        this.canvas.height = height;
        this.canvas.width = width;
        this.ctx = this.canvas.getContext("2d")

        let gradient = this.ctx.createLinearGradient(0,0, width, height);
        gradient.addColorStop(0, "#08ff00");
        gradient.addColorStop(0.33, "#fffb00");
        gradient.addColorStop(0.66, "#ff7300");
        gradient.addColorStop(1, "#ff0000");

        this.ctx.fillStyle = gradient;
        this.ctx.clearRect(0,0,width,height);
    }

    update(value) {
        value = Math.min(value, 1);
        this.ctx.clearRect(0,0, this.canvas.width, this.canvas.height);
        this.ctx.fillRect(0, 0, value*this.canvas.width, this.canvas.height);
    }
}
</code>
</pre>

        <h3 class="ui dividing header" id="send">
            Sending data from the processor :
        </h3>
        <p>
            We want to minimize the call to the update function of the vu-meter.
            That's why we will not send a message after each call of the process method in the processor.
        </p>
<pre class="line-numbers">
<code class="language-js">// audio-player-processor.js

const COUNT_BLOCK = 8;

class AudioPlayerProcessor extends AudioWorkletProcessor {

    /* Code of the processor
       ...
    */

    calculateMax(output) {
        for (let i = 0; i < output.length; i++) {
            this.max = Math.max(this.max, output[i]);
        }
        this.blockCount++;
        if (this.blockCount >= COUNT_BLOCK) {
            this.port.postMessage({volume: this.max});
            this.max = 0;
            this.blockCount = 0;
        }
    }

    process(inputs, outputs, parameters) {

        /* Process Audio
           ...
        */

        this.calculateMax(output[0]);
        return true;
    }
}
</code>
</pre>
        <p>
            For each 8 quantum blocks of the render process method, we check the maximum value of the output array.
            Then we send to the host the max value from all the audio with a <b>postMessage</b>.
        </p>
        <p>
            Then in the host we will retrieve the value of the max.
        </p>

        <h3 class="ui dividing header" id="receive">
            Receive volume in host :
        </h3>
<pre class="line-numbers">
<code class="language-js">// index.js

const vuMeterCanvas = document.getElementById("canvas2");

(async () => {

    const vuMeter = new VuMeter(vuMeterCanvas, 30, 200);

    /* Code of the host
       ...
    */

    node.port.onmessage = ev => {
        let vol = 0;
        let sensitivity = 1.3;
        if (ev.data.volume) {
            vol = ev.data.volume;
        }
        vuMeter.update(Math.abs(vol) * sensitivity);
    }

})();
</code>
</pre>
        <p>
            After creating the vuMeter, we can receive data from the processor using the audio node.
        </p>

        <h3 class="ui dividing header" id="conclusion">
            Conclusion :
        </h3>
        <p>
            We've seen how to get information from the processor in the host. We created a simple vu meter,
            but we can imagine any other implementation where we need to get information about the processor. For instance,
            making a playhead cursor for the host.
        </p>
    </section>
</div>

<div class="ui vertical footer segment">
    <div class="ui center aligned container">
        <div class="ui stackable grid">
            <div class="three wide column">
                <h4 class="ui header">Community</h4>
                <div class="ui link list">
                    <a class="item" href="https://github.com/webaudiomodules/api" target="_blank">Help contribute</a>
                    <a class="item" href="https://github.com/webaudiomodules/api/issues" target="_blank">Submit an
                        Issue</a>
                    <a class="item" href="https://gitter.im/Semantic-Org/Semantic-UI" target="_blank">Join our Chat</a>
                    <a class="item" href="https://www.webaudiomodules.org/">Community Website</a>
                </div>
            </div>
            <div class="three wide column">
                <h4 class="ui header">Network</h4>
                <div class="ui link list">
                    <a class="item" href="https://github.com/webaudiomodules/api" target="_blank">GitHub Repo</a>
                    <a class="item" href="https://www.w3.org/groups/wg/audio" target="_blank">W3C Audio Working
                        Groupe</a>
                    <a class="item" href="https://github.com/webaudiomodules/wam-examples/wiki">SDK Wiki</a>
                </div>
            </div>
            <div class="seven wide right floated column">
                <h4 class="ui header">Help to contibute to this project</h4>
                <form action="https://github.com/webaudiomodules"></form>
                <button type="submit" class="ui large orange button">Contribute to Web Audio Modules</button>
            </div>
        </div>
        <div class="ui section divider"></div>
        <img src="/assets/images/wam-logo.png" class="ui centered mini image">
        <div class="ui horizontal small divided link list">
            <a class="item" href="https://github.com/webaudiomodules/wam-examples/blob/master/LICENSE" target="_blank">Free
                &amp; Open Source (MIT)</a>
        </div>
    </div>
</div>



<script src="./index.js" type="module"></script>
<script src="../lib/prism/prism.js"></script>
<script>
    $('.ui.sidebar')
        // .sidebar('toggle');
    ;
</script>
</body>
</html>