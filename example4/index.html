<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Example 4 : JavaScript Web Audio Module 2.0 Processor with Plugin Automation</title>
    <link rel="icon" type="image/x-icon" href="../assets/images/wam-logo.png">
    <link rel="stylesheet" type="text/css" href="../lib/fomantic-ui/semantic.css">
    <link rel="stylesheet" href="../lib/prism/prism.css">
    <link rel="stylesheet" type="text/css" href="../lib/css/style.css">
    <script src="../lib/jquery/jquery-3.6.1.min.js"></script>
    <script src="../lib/fomantic-ui/semantic.js"></script>
    <script src="https://pixijs.download/release/pixi.js"></script>
    <script src="../lib/utils/normalize-points.js"></script>
</head>
<body>

<div class="ui visible left sidebar inverted vertical menu">
    <div class="item">
        <a class="ui logo icon image" href="/index.html">
            <img src="../assets/images/wam-logo.png" alt="logo wam" width="50px">
        </a>
        <a href="https://github.com/webaudiomodules">
            <b>Web Audio Modules</b>
        </a>
    </div>

    <a href="../example1-js/index.html" id="example1" class="item">Example 1</a>
    <div class="menu">
        <a class="item" href="../example1-js/index.html#demo">Demo</a>
        <a class="item" href="../example1-js/index.html#specifications">Specifications</a>
        <a class="item" href="../example1-js/index.html#prerequisites">Prerequisites</a>
        <a class="item" href="../example1-js/index.html#index">Index.html</a>
        <a class="item" href="../example1-js/index.html#operable">Operable audio buffer</a>
        <a class="item" href="../example1-js/index.html#main">Main script</a>
        <a class="item" href="../example1-js/index.html#init">Initialization</a>
        <a class="item" href="../example1-js/index.html#connection">Audio node connection</a>
        <a class="item" href="../example1-js/index.html#processor">Audio processor</a>
        <a class="item" href="../example1-js/index.html#conclusion">Conclusion</a>
    </div>
    <a href="../example2-js-cpp/index.html" id="example2" class="item">Example 2</a>
    <div class="menu">
        <a class="item" href="../example2-js-cpp/index.html#demo">Demo</a>
        <a class="item" href="../example2-js-cpp/index.html#specifications">Specifications</a>
        <a class="item" href="../example2-js-cpp/index.html#prerequisites">Prerequisites</a>
        <a class="item" href="../example2-js-cpp/index.html#makefile">Makefile compiling Emscripten</a>
        <a class="item" href="../example2-js-cpp/index.html#cpp">C++ File</a>
        <a class="item" href="../example2-js-cpp/index.html#audio-node">Custom Audio Node</a>
        <a class="item" href="../example2-js-cpp/index.html#instantiate">Instantiate Web Assembly</a>
        <a class="item" href="../example2-js-cpp/index.html#heaps">Initialize the heaps</a>
        <a class="item" href="../example2-js-cpp/index.html#conclusion">Conclusion</a>
    </div>
    <a href="../example3/index.html" id="example3" class="item">Example 3</a>
    <div class="menu">
        <a class="item" href="../example3/index.html#demo">Demo</a>
        <a class="item" href="../example3/index.html#specifications">Specifications</a>
        <a class="item" href="../example3/index.html#prerequisites">Prerequisites</a>
        <a class="item" href="../example3/index.html#WAM">Web Audio Modules</a>
        <a class="item" href="../example3/index.html#initialize">WAM SDK</a>
        <a class="item" href="../example3/index.html#creating">Instantiate plugins</a>
        <a class="item" href="../example3/index.html#processor">Custom WAM processor</a>
        <a class="item" href="../example3/index.html#conclusion">Conclusion</a>
    </div>
    <a id="example4" class="item active">Example 4</a>
    <div class="menu">
        <a class="item" href="#demo">Demo</a>
        <a class="item" href="#specifications">Specifications</a>
        <a class="item" href="#prerequisites">Prerequisites</a>
        <a class="item" href="#simulate">Simulate plugin automation</a>
        <a class="item" href="#connecting">Connecting WAM events</a>
        <a class="item" href="#handling">Handling events in processor</a>
        <a class="item" href="#conclusion">Conclusion</a>
    </div>
    <a href="../example5/index.html" id="example5" class="item">Example 5</a>
    <div class="menu">
        <a class="item" href="../example5/index.html#demo">Demo</a>
        <a class="item" href="../example5/index.html#specifications">Specifications</a>
        <a class="item" href="../example5/index.html#vu-meter">Vu meter class</a>
        <a class="item" href="../example5/index.html#send">Sending data from the processor</a>
        <a class="item" href="../example5/index.html#receive">Receive data from the host</a>
        <a class="item" href="../example5/index.html#conclusion">Conclusion</a>
    </div>
    <a href="../example6/index.html" id="example6" class="item active">Example 6</a>
    <div class="menu">
        <a class="item" href="../example6/index.html#demo">Demo</a>
        <a class="item" href="../example6/index.html#specifications">Specifications</a>
        <a class="item" href="../example6/index.html#prerequisites">Prerequisites</a>
        <a class="item" href="../example6/index.html#connection">Connection to MIDI</a>
        <a class="item" href="../example6/index.html#conclusion">Conclusion</a>
    </div>
    <div class="item">
        <a class="ui logo icon image" href="https://github.com/Brotherta/wam-examples">
            <img src="../assets/images/github-logo-light.png" alt="logo wam" width="25px">
        </a>
        <a href="https://github.com/Brotherta/wam-examples">
            <b>Github repository</b>
        </a>
    </div>
</div>

<div class="example-container">

    <h2 id="demo" class="ui dividing header">
        Example : JavaScript Web Audio Module 2.0 Processor with Plugin Automation
    </h2>

    <button id="btn-start-demo" class="ui button">Start Demo</button>

    <div id="demo-div" style="display: none">
        <div id="loading-wheel" class="loading">
            <img id="loading-gif" src="../assets/images/circle-loading.gif" alt="loading">
        </div>

        <div id="widget-loading" style="display: none">
            <h4 class="ui dividing header">Guitar Song : <a
                    href="https://www.chosic.com/download-audio/29514/">https://www.chosic.com/download-audio/29514/</a>
            </h4>

            <div class="wave">
                <canvas id="canvas1"></canvas>
            </div>

            <div class="demo-controls">
                <button id="btn-start" class="ui button">Start</button>
                <button id="btn-restart" class="ui button">Restart</button>
                <div class="ui toggle checkbox">
                    <input type="checkbox" name="loop" id="input-loop">
                    <label>Loop</label>
                </div>
            </div>
            <div class="plugins">
                <div id="mount1"></div>
                <div id="mount2"></div>
            </div>
        </div>
    </div>

    <section class="tutorial">
        <h3 class="ui dividing header" id="specifications">
            Specifications :
        </h3>
        <p>
            In this example, we will show how to automatize the parameters of a plugin. We will automatize
            the tone parameter of the Big Muff plugin. The tone will start from the minimum value to the maximum value.
            At half time of the music, the tone will decrease from the maximum to the minimum.
        </p>

        <h3 class="ui dividing header" id="prerequisites">
            Prerequisites :
        </h3>
        <p>
            The prerequisites of this example are the same as example 3. We will only add to the processor the events handlers for the automation.
        </p>

        <h3 class="ui dividing header" id="simulate">
            Simulate automation :
        </h3>
        <p>
            We will retrieve the parameters' information to add automation to the plugin. Then we will use them to simulate up-and-down automation of the tone parameter.
        </p>
        <pre class="code-snippets line-numbers">
<code class="language-js">// automation.js

export default async function applyAutomation(node, plugin, duration) {
    let info = await plugin._audioNode.getParameterInfo();

    const {minValue, maxValue, label, id} = Object.values(info)[4];
    console.log(minValue, maxValue, label, id);

    let parameterPoints = [
        {value: minValue, time: 0},
        {value: maxValue, time: duration/2},
        {value: minValue, time: duration}
    ];
    let normalizedPoints = normalizePoints(parameterPoints, minValue, maxValue, 0.5, duration, 0.01);

    let events = [];
    for (let i = 0; i&lt;normalizedPoints.length; i++) {
        events.push({type: 'wam-automation', data: {id: id, value: normalizedPoints[i].value}, time: audioCtx.currentTime + normalizedPoints[i].time});
    }
    node.scheduleEvents(...events);
}
</code>
</pre>
        <p>
            The parameterPoints are 3 points for the tone parameter. One at the beginning of the song with the minimum value, a second at half of the time to the maximum value, and the last one at the end of the song to the minimum value. We will use a function to normalize the points between the user's points. To do this, we will find the linear function of two successive points.
        </p>
        <p>
            To achieve this, we use this simple function :
        </p>

<pre class="line-numbers">
<code class="language-js">// utils.js to import in index.js

// Get from the linear function of points a and b, the value of the parameter at time t.
function getXFromY(a, b, t) {
    let gradient = (b.value - a.value)/(b.time - a.time);
    let intercept = b.value - gradient * b.time;
    return gradient * t + intercept;
}

function normalizePoints(points, minValue, maxValue, defValue, duration, step) {
    // If there is no point defined by the users.
    if (points.length === 0) {
        points.push({value: defValue, time: 0});
    }
    let firstPoint = points[0];
    let lastPoint = points[points.length-1];

    // If the first user point isn't set at the beginning of the audio.
    if (firstPoint.time !== 0) {
        points.unshift({value: defValue, time: 0});
    }
    // If the last user point isn't set at the end of the audio.
    if (lastPoint.time !== duration) {
        points.push({value: lastPoint.value, time: duration});
    }

    let normalizedPoints = []
    let pointIndex = 0;
    for (let t = 0; t < duration; t += step) {
        if (t > points[pointIndex+1].time) {
            pointIndex++;
        }
        let valueAtT = getXFromY(points[pointIndex], points[pointIndex+1], t);
        // If the current point is at the same time that the previous value, set to the previous value...
        if (isNaN(valueAtT)) {
            valueAtT = normalizedPoints[normalizedPoints.length-1].value;
        }
        normalizedPoints.push({value: valueAtT, time: t});
    }
    // Add the last point.
    normalizedPoints.push(points[pointIndex+1]);
    return normalizedPoints;
}
</code>
</pre>
        <p>
            With this function we can give 3 points, and with a precision of k step, normalize the points. After the points are normalized we can send them to the processor and queue them as events thanks to web audio modules.
        </p>

        <h3 class="ui dividing header" id="connecting">
            Connecting the plugins to the WAM events :
        </h3>
        <p>
            To handle the parameter events from the processor, we need to connect them to the Web Audio Module API.
        </p>
<pre class="line-numbers">
<code class="language-js">// index.js

(async ()=> {
    audioCtx.suspend()

    /* Code of the host
       ...
    */

    node.connectEvents(pluginInstance1._audioNode.instanceId);
    node.connectEvents(pluginInstance2._audioNode.instanceId);

    await applyAutomation(node, pluginInstance2, audioBuffer.duration);

    /*
     ...
    */

}();
</code>
</pre>
        <p>
            After connecting the plugins, we can now apply the automation. We will emit events to the processor. Events are composed of the type,
            the parameter identifier, the value of the parameter, and the time.
        </p>
        <p>
            Now that the automation is sent, we want to be cautious about the audio context behavior. We must be aware of when to stop and when to resume the audio context. Because the events are scheduled with the audio context time.
        </p>

        <h3 class="ui dividing header" id="handling">
            Handling events in the processor :
        </h3>
        <p>We will activate the automation events in the wam node. To achieve this only add this line to the audio node constructor : </p>
<code class="language-js">this._supportedEventTypes = new Set(['wam-automation']);</code>
        <p>To see all the supported events, refer to the wam api documentation.</p>
        <p>
            The processor need to handle events. To do that, we will add some methods in the processor code :
        </p>
<pre class="line-numbers">
<code class="language-js">// wam-audio-player-processor.js

class MyWamProcessor extends ModuleScope.WamProcessor {

    async _onMessage(e) {
        await super._onMessage(e);
        if (e.data.audio) {
            this.audio = e.data.audio;
        } else if (typeof e.data.position === "number") {
            this.playhead = e.data.position * sampleRate;
        } else if (e.data.restart) {
            this.playhead = 0;
        }
    }

    /**
     * Process the events received.
     */
    _processEvent(event) {
        this.emitEvents(event);
    }

    /**
     * When the automations events are called, this function is called.
     */
    _process() {}
}
</code>
</pre>
        <p>
            By calling the _onMessage super, when events are emitted from the main thread, the processor can schedule the events in the WAM module. When an event previously scheduled is called during the song, _processEvent will emit events to the wam group in the main thread. Plugins that are connected to the wam group will receive the events.
        </p>

        <h3 class="ui dividing header" id="conclusion">
            Conclusion :
        </h3>
        <p>
            You've seen how to use parameter automation in a wam plugin. For further more details, please see the full code in the <a target="_blank" href="http://github.com/Brotherta/wam-examples">github repository</a>. Next example we will see how to implement a simple vue meter.
        </p>
    </section>
</div>

<div class="ui vertical footer segment">
    <div class="ui center aligned container">
        <div class="ui stackable grid">
            <div class="three wide column">
                <h4 class="ui header">Community</h4>
                <div class="ui link list">
                    <a class="item" href="https://github.com/webaudiomodules/api" target="_blank">Help contribute</a>
                    <a class="item" href="https://github.com/webaudiomodules/api/issues" target="_blank">Submit an
                        Issue</a>
                    <a class="item" href="https://gitter.im/Semantic-Org/Semantic-UI" target="_blank">Join our Chat</a>
                    <a class="item" href="https://www.webaudiomodules.org/">Community Website</a>
                </div>
            </div>
            <div class="three wide column">
                <h4 class="ui header">Network</h4>
                <div class="ui link list">
                    <a class="item" href="https://github.com/webaudiomodules/api" target="_blank">GitHub Repo</a>
                    <a class="item" href="https://www.w3.org/groups/wg/audio" target="_blank">W3C Audio Working
                        Groupe</a>
                    <a class="item" href="https://github.com/webaudiomodules/wam-examples/wiki">SDK Wiki</a>
                </div>
            </div>
            <div class="seven wide right floated column">
                <h4 class="ui header">Help to contibute to this project</h4>
                <form action="https://github.com/webaudiomodules"></form>
                <button type="submit" class="ui large orange button">Contribute to Web Audio Modules</button>
            </div>
        </div>
        <div class="ui section divider"></div>
        <img src="/assets/images/wam-logo.png" class="ui centered mini image">
        <div class="ui horizontal small divided link list">
            <a class="item" href="https://github.com/webaudiomodules/wam-examples/blob/master/LICENSE" target="_blank">Free
                &amp; Open Source (MIT)</a>
        </div>
    </div>
</div>

</body>


<script src="./index.js" type="module"></script>
<script src="../lib/prism/prism.js"></script>
</html>