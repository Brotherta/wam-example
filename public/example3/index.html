<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Example 3 : Simple JavaScript Web Audio Module 2.0 Processor</title>
    <link rel="icon" type="image/x-icon" href="../assets/images/wam-logo.png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.0/dist/semantic.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/prismjs@1.29.0/themes/prism.min.css,npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
    <link rel="stylesheet" type="text/css" href="../lib/css/style.css">

    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.0/dist/semantic.min.js"></script>
</head>
<body>

<div class="ui visible left sidebar inverted vertical menu">
    <div class="item">
        <a class="ui logo icon image" href="/index.html">
            <img src="../assets/images/wam-logo.png" alt="logo wam" width="50px">
        </a>
        <a href="https://github.com/webaudiomodules">
            <b>Web Audio Modules</b>
        </a>
    </div>

    <a href="../example1-js/index.html" id="example1" class="item">Example 1</a>
    <div class="menu">
        <a class="item" href="../example1-js/index.html#demo">Demo</a>
        <a class="item" href="../example1-js/index.html#specifications">Specifications</a>
        <a class="item" href="../example1-js/index.html#prerequisites">Prerequisites</a>
        <a class="item" href="../example1-js/index.html#index">Index.html</a>
        <a class="item" href="../example1-js/index.html#operable">Operable audio buffer</a>
        <a class="item" href="../example1-js/index.html#main">Main script</a>
        <a class="item" href="../example1-js/index.html#init">Initialization</a>
        <a class="item" href="../example1-js/index.html#connection">Audio node connection</a>
        <a class="item" href="../example1-js/index.html#processor">Audio processor</a>
        <a class="item" href="../example1-js/index.html#conclusion">Conclusion</a>
    </div>
    <a href="../example2-js-cpp/index.html" id="example2" class="item">Example 2</a>
    <div class="menu">
        <a class="item" href="../example2-js-cpp/index.html#demo">Demo</a>
        <a class="item" href="../example2-js-cpp/index.html#specifications">Specifications</a>
        <a class="item" href="../example2-js-cpp/index.html#prerequisites">Prerequisites</a>
        <a class="item" href="../example2-js-cpp/index.html#makefile">Makefile compiling Emscripten</a>
        <a class="item" href="../example2-js-cpp/index.html#cpp">C++ File</a>
        <a class="item" href="../example2-js-cpp/index.html#audio-node">Custom Audio Node</a>
        <a class="item" href="../example2-js-cpp/index.html#instantiate">Instantiate Web Assembly</a>
        <a class="item" href="../example2-js-cpp/index.html#heaps">Initialize the heaps</a>
        <a class="item" href="../example2-js-cpp/index.html#conclusion">Conclusion</a>
    </div>
    <a id="example3" class="item active">Example 3</a>
    <div class="menu">
        <a class="item" href="#demo">Demo</a>
        <a class="item" href="#specifications">Specifications</a>
        <a class="item" href="#prerequisites">Prerequisites</a>
        <a class="item" href="#WAM">Web Audio Modules</a>
        <a class="item" href="#initialize">WAM SDK</a>
        <a class="item" href="#creating">Instantiate plugins</a>
        <a class="item" href="#processor">Custom WAM processor</a>
        <a class="item" href="#conclusion">Conclusion</a>
    </div>
    <a href="../example4/index.html" id="example4" class="item">Example 4</a>
    <div class="menu">
        <a class="item" href="../example4/index.html#demo">Demo</a>
        <a class="item" href="../example4/index.html#specifications">Specifications</a>
        <a class="item" href="../example4/index.html#prerequisites">Prerequisites</a>
        <a class="item" href="../example4/index.html#simulate">Simulate plugin automation</a>
        <a class="item" href="../example4/index.html#connecting">Connecting WAM events</a>
        <a class="item" href="../example4/index.html#handling">Handling events in processor</a>
        <a class="item" href="../example4/index.html#conclusion">Conclusion</a>
    </div>
    <a href="../example5/index.html" id="example5" class="item">Example 5</a>
    <div class="menu">
        <a class="item" href="../example5/index.html#demo">Demo</a>
        <a class="item" href="../example5/index.html#specifications">Specifications</a>
        <a class="item" href="../example5/index.html#vu-meter">Vu meter class</a>
        <a class="item" href="../example5/index.html#send">Sending data from the processor</a>
        <a class="item" href="../example5/index.html#receive">Receive data from the host</a>
        <a class="item" href="../example5/index.html#conclusion">Conclusion</a>
    </div>
    <a href="../example6/index.html" id="example6" class="item active">Example 6</a>
    <div class="menu">
        <a class="item" href="../example6/index.html#demo">Demo</a>
        <a class="item" href="../example6/index.html#specifications">Specifications</a>
        <a class="item" href="../example6/index.html#prerequisites">Prerequisites</a>
        <a class="item" href="../example6/index.html#connection">Connection to MIDI</a>
        <a class="item" href="../example6/index.html#conclusion">Conclusion</a>
    </div>
    <div class="item">
        <a class="ui logo icon image" href="https://github.com/Brotherta/wam-examples">
            <img src="../assets/images/github-logo-light.png" alt="logo wam" width="25px">
        </a>
        <a href="https://github.com/Brotherta/wam-examples">
            <b>Github repository</b>
        </a>
    </div>
</div>

<div class="example-container">

    <h2 id="demo" class="ui dividing header">
        Example : Simple JavaScript Web Audio Modules 2.0 Processor
    </h2>

    <button id="btn-start-demo" class="ui button">Start Demo</button>

    <div id="demo-div" style="display: none">
        <div id="loading-wheel" class="loading">
            <img id="loading-gif" src="../assets/images/circle-loading.gif" alt="loading">
        </div>

        <div id="widget-loading" style="display: none">
            <h4 class="ui dividing header">Guitar Song : <a
                    href="https://www.chosic.com/download-audio/29514/">https://www.chosic.com/download-audio/29514/</a>
            </h4>
            <div class="wave">
                <canvas class="waveform" id="canvas1"></canvas>
                <canvas class="playhead" id="playhead"></canvas>
            </div>
            <div class="demo-controls">
                <button id="btn-start" class="ui button">Start</button>
                <div class="ui toggle checkbox">
                    <input type="checkbox" name="loop" id="input-loop">
                    <label>Loop</label>
                </div>
            </div>
            <div class="plugins">
                <div id="mount1"></div>
                <div id="mount2"></div>
            </div>
        </div>
    </div>

    <section class="tutorial">
        <h3 class="ui dividing header" id="specifications">
            Specifications :
        </h3>
        <p>
            In this example, we will use a simple JavaScript processor, to keep the code simple.
            But of course, you can use the Web Assembly that we've seen in the example 2.
            Before jumping into the code, be sure to check the
            <a target="_blank" href="">Web Audio Modules API</a> first.
        </p>

        <h3 class="ui dividing header" id="prerequisites">
            Prerequisites :
        </h3>
        <p>
            To make our host communicates with the plugin, we will use the
            <a target="_blank" href="https://github.com/webaudiomodules/sdk">SDK</a> of Web Audio Modules.
            You can either download the full source and build it on your own, or use the pre-build version.
        </p>

        <h3 class="ui dividing header" id="WAM">
            Web Audio Modules Environment :
        </h3>
        <p>
            In this example we want to use our processor. To achieve that, we need to overwrite the WebAudioModule.
        </p>
        <pre class="code-snippets line-numbers">
<code class="language-js">// my-wam/js

import {WebAudioModule} from "../lib/sdk/index.js";
import MyWamNode from "./wam-audio-player-node.js";


export default class MyWam extends WebAudioModule {
    /**
     * @property {Function} createAudioNode
     * @override
     * @param initialState
     * @return {Promise&lt;MyWamNode>}
     */
    async createAudioNode(initialState) {
        await MyWamNode.addModules(this.moduleId);
        const node = new MyWamNode(this);

        // Initialize the node audio node. Register the processor in the audio context and the WAM group.
        node._initialize();
        return node;
    }
}
</code>
</pre>
        <p>
            At this point, we can now use the audio worklet and connect to the audio node of your processor.
            But in our case, we will transform the processor into a processor that follows the web audio modules standards.
        </p>
        <p>
            To use the processor, we will define the audio node. It extends WamNode.
        </p>
        <pre class="line-numbers">
<code class="language-js">// wam-audio-player-node.js
class MyWamNode extends WamNode {

    static async addModules(moduleId) {
        const {audioWorklet} = audioCtx;
        await super.addModules(audioCtx, moduleId);
        await addFunctionModule(audioWorklet, getProcessor, moduleId);
    }

    /* Code of the audio node
    ...
    */
}
</code>
        </pre>
        <p>
            We will talk about the <b>getProcessor</b> function afterwards while defining the wam processor.
            This functions will be called in the web audio modules class to register the custom processor.
        </p>

        <h3 class="ui dividing header" id="initialize">
            Initialize the SDK :
        </h3>
        <p>
            To work with WAM plugins, we need to keep the processor in the same group as the plugins.
            By initializing the sdk we will get a unique host group id.
        </p>
        <p>
            This host group id will be used when initializing the host and the plugins as follows :
        </p>
        <pre class="code-snippets line-numbers">
<code class="language-js">// index.js

(async ()=>{

    const {default: initializeWamHost} = await import("./sdk/initializeWamHost.js");
    const [hostGroupId] = await initializeWamHost(audioCtx);

    const {default: MyWam} = await import("./my-wam.js");
    const {default: WAM1} = await import(plugin1Url);
    const {default: WAM2} = await import(plugin2Url);
    /* Code of your host
       ...
    */
})();
</code>
</pre>
        <p>
            We can now use the audio worklet and connect to the audio node of your processor.
            But in our case, we will transform the processor into a processor that follows the web audio modules standards.
        </p>

        <h3 class="ui dividing header" id="creating">
            Creating instance of the plugins :
        </h3>
        <p>
            In the host, we can now instantiate the plugins and our wam environment.
        </p>
        <pre class="code-snippets line-numbers">
<code class="language-js">// index.js

(async ()=>{

    /*
       ...
    */

    let wamInstance = await MyWam.createInstance(hostGroupId, audioCtx);
    let pluginInstance1 = await WAM1.createInstance(hostGroupId, audioCtx);
    let pluginInstance2 = await WAM2.createInstance(hostGroupId, audioCtx);

    node.connect(pluginInstance1._audioNode).connect(pluginInstance2._audioNode).connect(audioCtx.destination);

    /* Code of your host
       ...
    */
})();
</code>
</pre>
        <p>
            Now that the instances are created, we can connect them into the destination. The <b>node</b> is our WAM environment,
            You can test the code with this, it will work properly, even with a simple audio worklet processor in JavaScript.
            But as said before, we want to customize our processor, and make it follow the WAM standards.
        </p>

        <h3 class="ui dividing header" id="processor">
            Custom Web Audio Modules processor :
        </h3>
        <p>
            he WAM processor is the same as pure JavaScript apart from the registering method in the Audio Worklet.
            In WAM the processor is registered in the GlobalScope of the Audio Worklet.
            To give access to the options, you will need to define a function that returns your processors as follows :
        </p>
        <pre class="code-snippets line-numbers">
<code class="language-js">// index.js

const getProcessor = (moduleId) => {
    const audioWorkletGlobalScope = globalThis;
    const {registerProcessor} = audioWorkletGlobalScope;
    const ModuleScope = audioWorkletGlobalScope.webAudioModules.getModuleScope(moduleId);

    class MyWamProcessor extends ModuleScope.WamProcessor {
        // code of your processor goes here.
    }

    try {
        registerProcessor(moduleId, MyWamProcessor);
    } catch (error) {
        console.warn(error);
    }
    return MyWamProcessor;
}
export default getProcessor;

</code>
</pre>
        <h3 class="ui dividing header" id="conclusion">
            Conclusion :
        </h3>
        <p>
            We've created a custom processor that follows the Web Audio Modules standards. We've connected multiple plugins,
            without effort to the host.
        </p>
        <p>
            But now we want to add logic inside our processor.
            To start with, we will see how to add parameters automation into the processor.
            We will try to automatize a parameter of a plugin.
        </p>
    </section>
</div>

<div class="ui vertical footer segment">
    <div class="ui center aligned container">
        <div class="ui stackable grid">
            <div class="three wide column">
                <h4 class="ui header">Community</h4>
                <div class="ui link list">
                    <a class="item" href="https://github.com/webaudiomodules/api" target="_blank">Help contribute</a>
                    <a class="item" href="https://github.com/webaudiomodules/api/issues" target="_blank">Submit an
                        Issue</a>
                    <a class="item" href="https://gitter.im/Semantic-Org/Semantic-UI" target="_blank">Join our Chat</a>
                    <a class="item" href="https://www.webaudiomodules.org/">Community Website</a>
                </div>
            </div>
            <div class="three wide column">
                <h4 class="ui header">Network</h4>
                <div class="ui link list">
                    <a class="item" href="https://github.com/webaudiomodules/api" target="_blank">GitHub Repo</a>
                    <a class="item" href="https://www.w3.org/groups/wg/audio" target="_blank">W3C Audio Working
                        Groupe</a>
                    <a class="item" href="https://github.com/webaudiomodules/wam-examples/wiki">SDK Wiki</a>
                </div>
            </div>
            <div class="seven wide right floated column">
                <h4 class="ui header">Help to contibute to this project</h4>
                <form action="https://github.com/webaudiomodules"></form>
                <button type="submit" class="ui large orange button">Contribute to Web Audio Modules</button>
            </div>
        </div>
        <div class="ui section divider"></div>
        <img src="/public/assets/images/wam-logo.png" class="ui centered mini image">
        <div class="ui horizontal small divided link list">
            <a class="item" href="https://github.com/webaudiomodules/wam-examples/blob/master/LICENSE" target="_blank">Free
                &amp; Open Source (MIT)</a>
        </div>
    </div>
</div>

<script src="./index.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/combine/npm/prismjs@1.29.0,npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
</body>
</html>